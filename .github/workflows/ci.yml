name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build core
        working-directory: spacecomms-core
        run: cargo build --release

      - name: Build adapters
        run: |
          cd spacecomms-adapters/space-track-mock && cargo build --release
          cd ../constellation-hub-mock && cargo build --release

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests
        working-directory: spacecomms-core
        run: cargo test --all-features

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check formatting
        working-directory: spacecomms-core
        run: cargo fmt --check

      - name: Run Clippy
        working-directory: spacecomms-core
        run: cargo clippy --all-targets -- -D warnings

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check documentation links
        run: |
          # Simple check that all markdown files exist
          for file in docs/*.md; do
            echo "Checking $file"
            if [ ! -f "$file" ]; then
              echo "Missing: $file"
              exit 1
            fi
          done
          echo "All documentation files present"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build, test]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        working-directory: spacecomms-core
        run: cargo build --release

      - name: Start node and test health
        run: |
          cd spacecomms-core
          ./target/release/spacecomms start --config ../examples/config.yaml &
          sleep 3
          
          # Test health endpoint
          HEALTH=$(curl -s http://localhost:8080/health)
          echo "Health response: $HEALTH"
          
          if echo "$HEALTH" | grep -q '"status":"healthy"'; then
            echo "Health check passed"
          else
            echo "Health check failed"
            exit 1
          fi
          
          # Cleanup
          pkill spacecomms || true

  # Optional: Publish Docker image on tagged releases
  # docker:
  #   name: Docker
  #   runs-on: ubuntu-latest
  #   needs: [build, test, lint]
  #   if: startsWith(github.ref, 'refs/tags/')
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Build Docker image
  #       run: docker build -t spacecomms:${{ github.ref_name }} .
  #     
  #     - name: Push to registry
  #       run: |
  #         # docker push your-registry/spacecomms:${{ github.ref_name }}
  #         echo "Would push to registry here"
